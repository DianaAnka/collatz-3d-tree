<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Collatz Conjecture 3D Tree</title>
  <style>
    body { margin: 0; overflow: hidden; background: radial-gradient(ellipse at center, #0a0a0f 0%, #000000 100%); }
    canvas { display: block; }
    #info {
      position: absolute; top: 10px; left: 10px; color: #fff; font-family: sans-serif;
      background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px;
    }
  </style>
</head>
<body>
<div id="info">Collatz Conjecture 3D ðŸŒŒ</div>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<!-- Postprocessing scripts -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

<!-- Utilities -->
<script src="https://cdn.jsdelivr.net/npm/chroma-js@2.4.2/chroma.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lil-gui@0.17"></script>

<script>
const scene = new THREE.Scene();

// Camera
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 20, 60);

// Renderer
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);

// Controls
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.autoRotate = true;
controls.autoRotateSpeed = 0.7;

// Lights
scene.add(new THREE.HemisphereLight(0xffffff, 0x222222, 1.2));
const dirLight = new THREE.DirectionalLight(0xffffff, 1);
dirLight.position.set(10, 20, 10);
scene.add(dirLight);

// Postprocessing (Bloom)
const composer = new THREE.EffectComposer(renderer);
composer.addPass(new THREE.RenderPass(scene, camera));
const bloomPass = new THREE.UnrealBloomPass(
  new THREE.Vector2(window.innerWidth, window.innerHeight),
  1.2, 0.4, 0.85
);
composer.addPass(bloomPass);

// GUI parameters
const params = {
  maxN: 200,
  bloomStrength: 1.2,
  autoRotateSpeed: 0.7,
  rebuild: buildTree
};

// Collatz sequence generator
function collatz(n) {
  let seq = [n];
  while (n !== 1) {
    n = n % 2 === 0 ? n / 2 : 3 * n + 1;
    seq.push(n);
    if (seq.length > 200) break;
  }
  return seq;
}

// Build Collatz tree as tubes
function buildTree() {
  // Remove old meshes
  for (let i = scene.children.length - 1; i >= 0; i--) {
    if (scene.children[i].isMesh) scene.remove(scene.children[i]);
  }

  const colorScale = chroma.scale(["#ff0080", "#00ffff", "#ffcc00"]).mode("lch");

  for (let n = 2; n < params.maxN; n++) {
    const seq = collatz(n);
    const points = seq.map((val, i) => new THREE.Vector3(
      Math.log(val) * Math.sin(i * 0.3),
      i * 0.3,
      Math.log(val) * Math.cos(i * 0.3)
    ));

    if (points.length > 1) {
      const curve = new THREE.CatmullRomCurve3(points);
      const geometry = new THREE.TubeGeometry(curve, 100, 0.05, 8, false);
      const material = new THREE.MeshStandardMaterial({
        color: colorScale(Math.log(n)/Math.log(params.maxN)).hex(),
        metalness: 0.6,
        roughness: 0.2
      });
      const tube = new THREE.Mesh(geometry, material);
      scene.add(tube);
    }
  }
}
buildTree();

// GUI controls
const gui = new lil.GUI();
gui.add(params, 'maxN', 50, 500, 10).name("Max N").onChange(buildTree);
gui.add(params, 'bloomStrength', 0, 3, 0.1).name("Bloom").onChange(v => bloomPass.strength = v);
gui.add(params, 'autoRotateSpeed', 0, 5, 0.1).name("Rotate Speed").onChange(v => controls.autoRotateSpeed = v);

// Animation loop
function animate() {
  requestAnimationFrame(animate);
  controls.update();
  composer.render();
}
animate();

// Handle resize
window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  composer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
